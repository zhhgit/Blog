---
layout: post
title: "gulpfile.js"
description: gulpfile.js
modified: 2015-09-07
category: Tool
tags: [Tool]
featured: true
---

典型gulpfile.js:

	var forRel = false;   // css min, js compress, uglify only for release mode.

	var gulp = require('gulp'),
	    concat = require('gulp-concat'),
	    uglify = require('gulp-uglify'),
	    less = require('gulp-less'),
	    minifycss = require('gulp-minify-css'),
	    minifyhtml = require('gulp-minify-html'),
	    gulpif = require('gulp-if'),
	    connect = require('gulp-connect');
	    //gutil = require('gulp-util');

	//资源版本号
	var version = process.cwd().match(/\d+$/)[0] + '/';
	var srcDir = '';
	var srcDir4commonModule = '../commonModule';
	var releaseDir = '../../../wl/web/' + version;
	var releaseDir4commonModule = '../../../wl/web/commonModule';


	// {任务名称:{任务配置}}
	var tasks = {
	    'less': {
	        handler: 'less',
	        src: [srcDir + 'less/*.less'],
	        dest: srcDir + 'css'
	    },

	    'css-commonModule': {
	        handler: 'css-commonModule',
	        src: [srcDir4commonModule + '/**/*.css'],
	        dest: releaseDir4commonModule
	    },

	    'js': {
	        handler: 'js',
	        src: [srcDir + 'js/**/*.js'],
	        dest: releaseDir + 'js'
	    },

	    'js-cordova': {
	        handler: 'js',
	        src: ['../*.js'],
	        dest: releaseDir.replace(version, '')
	    },

	    'allPluginsMerged':{
	        handler: 'js',
	        src: [srcDir + 'js/UPWebPlugin/UPWeb*.js', srcDir + 'js/UPWebPlugin/Contacts.js'],
	        concat: 'allPluginsMerged.js',
	        dest: srcDir + 'js/UPWebPlugin'
	    },

	    'js-commonModule': {
	        handler: 'js-commonModule',
	        src: [srcDir4commonModule + '/**/*.js'],
	        dest: releaseDir4commonModule
	    },

	    'html': {
	        handler: 'html',
	        src: [srcDir + 'page/**/*.html', 'page/**/*.manifest'],
	        dest: releaseDir + 'page'
	    },

	    'images': {
	        handler: 'file',
	        src: [srcDir + 'images/**'],
	        dest: releaseDir + 'images'
	    },

	    'css': {
	        handler: 'file',
	        src: [srcDir + 'css/*.css'],
	        dest: releaseDir + 'css'
	    },

	    'file': {
	        handler: 'file',
	        src: [srcDir4commonModule + '/**/*.tpl'],
	        dest: releaseDir4commonModule
	    }/*,

	    'commonAll.js':{
	         handler: 'js',
	         src: [srcDir + 'js/base/*.js'],
	         concat: 'commonAll.js',
	         //dest: releaseDir + 'js/base'
	         dest: srcDir + 'js/base'
	    }*/
	};

	var ifconcat = function (concatName) {
	    return !!concatName ? concat(concatName) : 1;
	};

	// 根据任务的不同类型作对应处理
	var taskHandler = {
	    'less': function (options) {
	        gulp.src(options.src)
	            .pipe(gulpif(!!options.concat, ifconcat(options.concat)))
	            .pipe(less().on('error', function (e) {
	                console.log(e)
	            }))
	            .pipe(gulpif(forRel, minifycss({
	                compatibility: '*',
	                advanced: false
	            })))
	            .pipe(gulp.dest(options.dest))
	    },

	    'css-commonModule': function (options) {
	        gulp.src(options.src)
	            .pipe(gulpif(!!options.concat, ifconcat(options.concat)))
	            .pipe(gulpif(forRel, minifycss({
	                compatibility: '*',
	                advanced: false
	            })))
	            .pipe(gulp.dest(options.dest))
	    },

	    'js': function (options) {
	        gulp.src(options.src)
	            .pipe(gulpif(!!options.concat, ifconcat(options.concat)))
	            .pipe(gulpif(forRel, uglify()))
	            .pipe(gulp.dest(options.dest))
	    },

	    'js-commonModule': function (options) {
	        gulp.src(options.src)
	            .pipe(gulpif(!!options.concat, ifconcat(options.concat)))
	            .pipe(gulpif(forRel, uglify()))
	            .pipe(gulp.dest(options.dest))
	    },

	    'html': function (options) {
	        gulp.src(options.src)
	            .pipe(gulpif(!!options.concat, ifconcat(options.concat)))
	            .pipe(minifyhtml({quotes: 1}))
	            .pipe(gulp.dest(options.dest))
	    },

	    'img': function (options) {
	        gulp.src(options.src)
	            .pipe(imagemin())
	            .pipe(gulp.dest(options.dest))
	    },

	    'file': function (options) {
	        gulp.src(options.src)
	            .pipe(gulp.dest(options.dest))
	    }
	};


	var allTasks = [];

	// 注册任务
	for (var taskName in tasks) {
	    (function (options) {
	        gulp.task(taskName, function () {
	            taskHandler[options.handler](options);
	        });
	        allTasks.push(taskName);
	    })(tasks[taskName]);
	}


	// server
	gulp.task('server', function () {
	    connect.server({
	        root: '../../../',
	        livereload: true
	    });
	});


	// watch dev
	gulp.task('watch', function () {
	    var i, taskName;

	    // live reload
	    for (i in allTasks) {
	        taskName = allTasks[i];

	        gulp.watch(tasks[taskName].src, function () {
	            gulp.src(tasks[taskName].src)
	                .pipe(connect.reload());
	        })
	    }

	    // live tasks
	    for (i in ['less']) {
	        taskName = allTasks[i];
	        gulp.watch(tasks[taskName].watch || tasks[taskName].src, [taskName]);
	    }
	});

	// all dev
	gulp.task('default', ['less', 'server', 'watch']);

	// release
	gulp.task('release', allTasks);

	// debug
	gulp.task('debug', function() {
	    debug = true;
	    //gutil.log( gutil.colors.green('RUNNING IN DEBUG MODE') );
	    gulp.start('release');
	});

更简单一点的：

	var gulp = require('gulp'),
	    uglify = require('gulp-uglify'),
	    minifycss = require('gulp-clean-css'),
	    minifyhtml = require('gulp-html-minifier'),
	    rev = require('gulp-rev-append'),
	    sourcemaps = require('gulp-sourcemaps');

	var paths = {
	    // 需要打包的所有JS文件
	    js: [
	        'web/!(400|test)/**/!(config).js',
	        'web/*.js'
	    ],
	    css: [
	        'web/!(400|test)/**/*.css'
	    ],
	    html: [
	        'web/!(400|test)/**/*.html',
	        'web/!(400|test)/**/*.tpl'
	    ],
	    file: [
	        'web/!(400|test)/**/*.jpg',
	        'web/!(400|test)/**/*.png',
	        'web/!(400|test)/**/*.gif',
	        'web/!(400|test)/**/*.manifest',
	        'web/!(400|test)/**/config.js'
	    ]
	};

	var destDir = './wallet_web/web';
	var mapDir = '../../wallet_web_maps/web';

	gulp.task('release', function () {
	    // 打包所有JS文件
	    gulp.src(paths.js)
	        .pipe(sourcemaps.init())
	        .pipe(uglify({
	            compress: {
	                // 移除console语句
	                drop_console: true
	            },
	            mangle: {except: ['require', 'exports', 'module', '$']}
	        }))
	        .pipe(sourcemaps.write(mapDir, {addComment: false}))
	        .pipe(gulp.dest(destDir));

	    // 打包所有CSS文件
	    gulp.src(paths.css)
	        .pipe(sourcemaps.init())
	        .pipe(minifycss({
	            compatibility: '*',
	            advanced: false
	        }))
	        .pipe(sourcemaps.write(mapDir, {addComment: false}))
	        .pipe(gulp.dest(destDir));

	    gulp.src(paths.html)
	        .pipe(rev())
	        .pipe(sourcemaps.init())
	        .pipe(minifyhtml({
	            // 压缩空格
	            collapseWhitespace: true,
	            minifyJS: true,
	            minifyCSS: true,
	            removeComments: true
	        }))
	        .pipe(sourcemaps.write(mapDir, {addComment: false}))
	        .pipe(gulp.dest(destDir));

	    // 打包所有无需预处理的文件
	    gulp.src(paths.file)
	        .pipe(gulp.dest(destDir));
	});


	gulp.task('default', ['release']);

